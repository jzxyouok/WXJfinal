<script type="text/javascript">
    var setting = {
        async: {
            enable: true,
            url: '${cxt!}/jf/room/modules/treeData',
            autoParam: ["id=ids"],
            dataFilter: filter,
            type: "post"
        },
        view: {
            fontCss: getFont,
            expandSpeed: "",
            selectedMulti: false
        },
        check: {
            enable: true,
            chkStyle: "radio",
            radioType: "all"
        },
        data: {
            simpleData: {
                enable: true
            }
        },
        callback: {
            beforeAsync: beforeAsync,	//用于捕获异步加载之前的事件回调函数,zTree 根据返回值确定是否允许进行异步加载
            onAsyncSuccess: onAsyncSuccess,	//用于捕获异步加载出现异常错误的事件回调函数
            onAsyncError: onAsyncError,	//用于捕获异步加载正常结束的事件回调函数

            beforeCheck: beforeCheck,
            onCheck: onCheck
        }
    };

    //节点数据过滤 + 默认选中
    var modulesIds = '${paramMap.ids},';
    function filter(treeId, parentNode, childNodes) {
        if (!childNodes) {
            return null;
        }
        var childNode;
        var childNodeId;
        var childNodeName;
        var zTree = $.fn.zTree.getZTreeObj("zTreeContent");
        for (var i = 0, l = childNodes.length; i < l; i++) {
            childNode = childNodes[i];
            childNodeId = childNode.id;
            childNodeName = childNode.name;
            childNode.name = childNodeName.replace(/\.n/g, '.');

            if (modulesIds != '' && modulesIds.indexOf(childNodeId + ',') != -1) {
                zTree.checkNode(childNode, true, false, false);
            }
        }
        return childNodes;
    }

    //字体设置
    function getFont(treeId, node) {
        return node.font ? node.font : {};
    }

    ////////////////////下面是处理展开//////////////////
    //用于捕获异步加载之前的事件回调函数,zTree 根据返回值确定是否允许进行异步加载
    function beforeAsync() {
        curAsyncCount++;
    }

    //用于捕获异步加载出现异常错误的事件回调函数
    function onAsyncSuccess(event, treeId, treeNode, msg) {
        curAsyncCount--;
        if (curStatus == "expand") {
            expandNodes(treeNode.children);
        } else if (curStatus == "async") {
            asyncNodes(treeNode.children);
        }

        if (curAsyncCount <= 0) {
            if (curStatus != "init" && curStatus != "") {
                asyncForAll = true;
            }
            curStatus = "";
        }
    }

    //用于捕获异步加载正常结束的事件回调函数
    function onAsyncError(event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown) {
        curAsyncCount--;

        if (curAsyncCount <= 0) {
            curStatus = "";
            if (treeNode != null) asyncForAll = true;
        }
    }

    //////////////////选中事件处理////////////////////
    var className = "dark", checkedNodeIds = "${paramMap.ids!}", checkedNodeName = "";

    function beforeCheck(treeId, treeNode) {
        className = (className === "dark" ? "" : "dark");
        return (treeNode.doCheck !== false);
    }

    function onCheck(e, treeId, treeNode) {
        checkedNodeIds = treeNode.id;
        checkedNodeName = treeNode.name;
    }

    function setCheckValue() {
        $("#${paramMap.mids!}").val(checkedNodeIds);
        $("#${paramMap.mName!}").val(checkedNodeName);
    }


    var curStatus = "init", curAsyncCount = 0, asyncForAll = false, goAsync = false;
    function expandAll() {
        if (!check()) {
            return;
        }
        var zTree = $.fn.zTree.getZTreeObj("zTreeContent");
        if (asyncForAll) {
            zTree.expandAll(true);
        } else {
            expandNodes(zTree.getNodes());
            if (!goAsync) {
                curStatus = "";
            }
        }
    }
    function check() {
        if (curAsyncCount > 0) {
            return false;
        }
        return true;
    }
    function expandNodes(nodes) {
        if (!nodes) {
            return;
        }
        curStatus = "expand";
        var zTree = $.fn.zTree.getZTreeObj("zTreeContent");
        for (var i = 0, l = nodes.length; i < l; i++) {
            zTree.expandNode(nodes[i], true, false, false);
            if (nodes[i].isParent && nodes[i].zAsync) {
                expandNodes(nodes[i].children);
            } else {
                goAsync = true;
            }
        }
    }
    //////////////////初始化////////////////////

    $(document).ready(function () {
        $.fn.zTree.init($("#zTreeContent"), setting);
    });
    setTimeout(function () {
        expandAll();
    }, 500);
</script>

<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h4 class="modal-title">${i18nMap["admin.modules.radio"]}</h4>
        </div>
        <div class="modal-body">
            <ul id="zTreeContent" class="ztree"></ul>
        </div>
        <div class="modal-footer">
            <a href="javascript:;" class="btn btn-sm btn-white"
               data-dismiss="modal">${i18nMap["admin.common.close"]}</a>
            <a data-dismiss="modal" href="javascript:;" class="btn btn-sm btn-success" onclick="setCheckValue()">${i18nMap["admin.common.determine"]}</a>
        </div>
    </div>
</div>